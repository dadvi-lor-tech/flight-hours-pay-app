<?xml version="1.0" encoding="UTF-8"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_5.2.xsd">

  <chart name="cumulated.hours.year.chart" title="Cumulated hours on year">
    <dataset type="sql">
      SELECT departure_date AS day,
       SUM(actual_duration) 
         OVER (PARTITION BY to_char(departure_date, 'YYYY') ORDER BY departure_date) / 3600.0 AS hours
      FROM flight_actual_duty
      WHERE duty IN (SELECT id FROM flight_duty WHERE is_leave = 'f')
        AND date_part('year', departure_date) = date_part('year', CURRENT_DATE)
      </dataset>
    <category key="day" title="Day" type="date" />
    <series key="hours" title="Cumulated hours" type="line" />
  </chart>

  <chart name="cumulated.hours.last.period.charts" title="Cumulated hours on period" onInit="action-chart-attrs-default-dates">
    <search-fields>
      <field name="startDate" title="Start date" type="date" />
      <field name="endDate" title="End date" type="date" />
    </search-fields>
    <!-- TODO: hours must cumulate themselves -->
    <dataset type="jpql">
        SELECT
          self.departureDate AS day,
          self.actualDuration / 3600 AS hours
        FROM ActualDuty self
        WHERE self.duty.isLeave = 'f'
          AND self.departureDate &gt; :startDate
          AND self.departureDate &lt; :endDate
      </dataset>
    <category key="day" title="Day" type="date" />
    <series key="hours" title="Cumulated hours on last period" type="line" />
  </chart>

  <action-attrs name="action-chart-attrs-default-dates">
    <attribute name="value" for="startDate" expr="eval: LocalDate.now().withDayOfMonth(1)" />
    <attribute name="value" for="endDate" expr="eval: LocalDate.now().withDayOfMonth(LocalDate.now().lengthOfMonth())" />
  </action-attrs>

</object-views>